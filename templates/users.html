{% extends "base.html" %}

{% block title %}Управление пользователями - Админ-панель{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-users-cog me-2"></i>Управление пользователями
        </h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-plus me-2"></i>Добавить пользователя
                </h5>
                <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#addUserForm">
                    <i class="fas fa-plus me-2"></i>Добавить
                </button>
            </div>
            <div class="card-body collapse" id="addUserForm">
                <form id="createUserForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username *</label>
                                <input type="text" class="form-control" id="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">Пароль *</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fullName" class="form-label">Полное имя</label>
                                <input type="text" class="form-control" id="fullName">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="role" class="form-label">Роль</label>
                                <select class="form-select" id="role">
                                    <option value="user">Пользователь</option>
                                    <option value="admin">Администратор</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="accountExpires" class="form-label">Истекает</label>
                                <input type="datetime-local" class="form-control" id="accountExpires">
                                <small class="text-muted">Оставьте пустым для бессрочного доступа</small>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-2"></i>Создать пользователя
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Список пользователей
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" id="refreshBtn">
                        <i class="fas fa-sync-alt me-2"></i>Обновить
                    </button>
                    <button class="btn btn-outline-success btn-sm" id="exportBtn">
                        <i class="fas fa-download me-2"></i>Экспорт CSV
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if users %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Username</th>
                                    <th>Имя</th>
                                    <th>Email</th>
                                    <th>Роль</th>
                                    <th>Статус</th>
                                    <th>Истекает</th>
                                    <th>Создан</th>
                                    <th>Последний вход</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        <code>{{ user.username }}</code>
                                        {% if user.role == 'admin' %}
                                            <i class="fas fa-crown text-warning ms-1" title="Администратор"></i>
                                        {% endif %}
                                    </td>
                                    <td>{{ user.full_name or 'Не указано' }}</td>
                                    <td>{{ user.email or 'Не указан' }}</td>
                                    <td>
                                        <span class="badge {% if user.role == 'admin' %}bg-warning{% else %}bg-info{% endif %}">
                                            {{ user.role }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if user.is_active %}
                                            <span class="badge bg-success">Активен</span>
                                        {% else %}
                                            <span class="badge bg-danger">Неактивен</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.account_expires %}
                                            <small class="text-muted">{{ user.account_expires[:10] }}</small>
                                        {% else %}
                                            <span class="text-success">Бессрочно</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ user.created_at[:10] }}</small>
                                    </td>
                                    <td>
                                        {% if user.last_login %}
                                            <small class="text-muted">{{ user.last_login[:10] }}</small>
                                        {% else %}
                                            <span class="text-muted">Никогда</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" 
                                                    onclick="editUser('{{ user.username }}')"
                                                    title="Редактировать">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-warning" 
                                                    onclick="changePassword('{{ user.username }}')"
                                                    title="Сменить пароль">
                                                <i class="fas fa-key"></i>
                                            </button>
                                            <button class="btn btn-outline-info" 
                                                    onclick="setExpiry('{{ user.username }}')"
                                                    title="Установить время истечения">
                                                <i class="fas fa-clock"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Всего пользователей: <strong>{{ users|length }}</strong>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <div class="display-4 text-muted mb-3">
                            <i class="fas fa-users"></i>
                        </div>
                        <h4 class="text-muted">Пока нет пользователей</h4>
                        <p class="text-muted">Добавьте первого пользователя через форму выше</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для смены пароля -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-key me-2"></i>Смена пароля
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Пользователь:</label>
                    <input type="text" class="form-control" id="changePasswordUsername" readonly>
                </div>
                <div class="mb-3">
                    <label for="newPassword" class="form-label">Новый пароль:</label>
                    <input type="password" class="form-control" id="newPassword" required>
                </div>
                <div class="mb-3">
                    <label for="confirmPassword" class="form-label">Подтвердите пароль:</label>
                    <input type="password" class="form-control" id="confirmPassword" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="savePasswordBtn">
                    <i class="fas fa-save me-2"></i>Сохранить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для установки времени истечения -->
<div class="modal fade" id="setExpiryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clock me-2"></i>Время истечения аккаунта
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Пользователь:</label>
                    <input type="text" class="form-control" id="setExpiryUsername" readonly>
                </div>
                <div class="mb-3">
                    <label for="expiryDate" class="form-label">Дата истечения:</label>
                    <input type="datetime-local" class="form-control" id="expiryDate">
                    <small class="text-muted">Оставьте пустым для бессрочного доступа</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveExpiryBtn">
                    <i class="fas fa-save me-2"></i>Сохранить
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.getElementById('refreshBtn');
    const exportBtn = document.getElementById('exportBtn');
    const createUserForm = document.getElementById('createUserForm');
    
    // Обновление списка
    refreshBtn.addEventListener('click', function() {
        location.reload();
    });
    
    // Создание пользователя
    createUserForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            username: document.getElementById('username').value,
            password: document.getElementById('password').value,
            role: document.getElementById('role').value,
            full_name: document.getElementById('fullName').value || null,
            email: document.getElementById('email').value || null,
            account_expires: document.getElementById('accountExpires').value || null
        };
        
        fetch('/api/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Пользователь создан успешно!');
                location.reload();
            } else {
                alert('Ошибка: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            alert('Ошибка создания пользователя');
        });
    });
    
    // Экспорт в CSV
    exportBtn.addEventListener('click', function() {
        const users = {{ users|tojson }};
        
        const headers = [
            'Username', 'Имя', 'Email', 'Роль', 'Статус', 
            'Истекает', 'Создан', 'Последний вход'
        ];
        
        const csvData = users.map(user => [
            user.username,
            user.full_name || 'Не указано',
            user.email || 'Не указан',
            user.role,
            user.is_active ? 'Активен' : 'Неактивен',
            user.account_expires ? user.account_expires.slice(0, 10) : 'Бессрочно',
            user.created_at ? user.created_at.slice(0, 10) : 'Неизвестно',
            user.last_login ? user.last_login.slice(0, 10) : 'Никогда'
        ]);
        
        const csvContent = "data:text/csv;charset=utf-8," 
            + headers.join(',') + "\n"
            + csvData.map(row => row.map(cell => `"${cell}"`).join(',')).join("\n");
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "users.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
});

// Функции для модальных окон
function changePassword(username) {
    document.getElementById('changePasswordUsername').value = username;
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
    modal.show();
}

function setExpiry(username) {
    document.getElementById('setExpiryUsername').value = username;
    document.getElementById('expiryDate').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('setExpiryModal'));
    modal.show();
}

// Обработчики модальных окон
document.getElementById('savePasswordBtn').addEventListener('click', function() {
    const username = document.getElementById('changePasswordUsername').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        alert('Пароли не совпадают!');
        return;
    }
    
    if (!newPassword) {
        alert('Введите новый пароль!');
        return;
    }
    
    fetch(`/api/users/${username}/password`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ new_password: newPassword })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Пароль обновлен успешно!');
            bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Ошибка обновления пароля');
    });
});

document.getElementById('saveExpiryBtn').addEventListener('click', function() {
    const username = document.getElementById('setExpiryUsername').value;
    const expiryDate = document.getElementById('expiryDate').value;
    
    fetch(`/api/users/${username}/expiry`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ account_expires: expiryDate || null })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Время истечения обновлено успешно!');
            bootstrap.Modal.getInstance(document.getElementById('setExpiryModal')).hide();
            location.reload();
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Ошибка обновления времени истечения');
    });
});
</script>
{% endblock %}
