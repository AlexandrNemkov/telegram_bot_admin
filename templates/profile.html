{% extends "base.html" %}

{% block title %}–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h3>üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h3>
                </div>
                <div class="card-body">
                    {% if user_info %}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Username:</strong></td>
                                    <td>{{ user_info.username }}</td>
                                </tr>
                                <tr>
                                    <td><strong>–ü–æ–ª–Ω–æ–µ –∏–º—è:</strong></td>
                                    <td>{{ user_info.full_name or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>{{ user_info.email or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>–†–æ–ª—å:</strong></td>
                                    <td>
                                        {% if user_info.role == 'admin' %}
                                            <span class="badge bg-danger">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                                        {% else %}
                                            <span class="badge bg-primary">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>–°—Ç–∞—Ç—É—Å:</strong></td>
                                    <td>
                                        {% if user_info.is_active %}
                                            <span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                                        {% else %}
                                            <span class="badge bg-danger">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>‚è∞ –í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>–°–æ–∑–¥–∞–Ω:</strong></td>
                                    <td>{{ user_info.created_at or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥:</strong></td>
                                    <td>{{ user_info.last_login or '–ù–∏–∫–æ–≥–¥–∞' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>–ò—Å—Ç–µ–∫–∞–µ—Ç:</strong></td>
                                    <td>
                                        {% if user_info.account_expires %}
                                            {{ user_info.account_expires }}
                                        {% else %}
                                            <span class="text-success">–ë–µ—Å—Å—Ä–æ—á–Ω–æ</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <hr>

                    <div class="row">
                        <div class="col-md-6">
                            <h5>üîê –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h5>
                            <form id="changePasswordForm">
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                                    <input type="password" class="form-control" id="currentPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                    <input type="password" class="form-control" id="newPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                    <input type="password" class="form-control" id="confirmPassword" required>
                                </div>
                                <button type="submit" class="btn btn-warning">üîÑ –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <h5>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h5>
                            <div class="alert alert-info">
                                <h6>üîí –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∞—Ä–æ–ª—é:</h6>
                                <ul class="mb-0">
                                    <li>–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤</li>
                                    <li>–ë—É–∫–≤—ã –≤–µ—Ä—Ö–Ω–µ–≥–æ –∏ –Ω–∏–∂–Ω–µ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞</li>
                                    <li>–¶–∏—Ñ—Ä—ã –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã</li>
                                    <li>–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–∏—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div class="modal fade" id="notificationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const changePasswordForm = document.getElementById('changePasswordForm');
    
    changePasswordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª–µ–π
        if (newPassword !== confirmPassword) {
            showNotification('–û—à–∏–±–∫–∞', '–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!', 'error');
            return;
        }
        
        if (newPassword.length < 8) {
            showNotification('–û—à–∏–±–∫–∞', '–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤!', 'error');
            return;
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
        fetch('/api/profile/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('–£—Å–ø–µ—Ö', '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!', 'success');
                changePasswordForm.reset();
            } else {
                showNotification('–û—à–∏–±–∫–∞', data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å', 'error');
            }
        })
        .catch(error => {
            showNotification('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è', 'error');
            console.error('Error:', error);
        });
    });
    
    function showNotification(title, message, type) {
        const modal = new bootstrap.Modal(document.getElementById('notificationModal'));
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        
        modalTitle.textContent = title;
        modalBody.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'danger'}">${message}</div>`;
        
        modal.show();
    }
});
</script>
{% endblock %}
